<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Test Cockpit Cliquable</title>
<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --ok:#22c55e;
  --bof:#fbbf24;
  --bad:#ef4444;
  --btn:#2563eb;
  --surface:#0b1223;
  --border:#334155;
}
/* ===== Palette light identique √† tes QCM ===== */
:root[data-theme="light"]{
  --bg:#f5f7fa;
  --card:#ffffff;
  --text:#111827;
  --muted:#374151;
  --ok:#007A33;
  --bof:#FFD200;
  --bad:#C1121F;
  --btn:#003366;
  --surface:#f0f4f8;
  --border:#cbd5e1;
}

html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,sans-serif;
  padding:16px;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
}

/* ===== Cartes & layout identiques ===== */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.15);
  padding:16px;
}
.main{
  width:100%;
  max-width:900px;
}
h1{margin:0 0 10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select,input,button{
  padding:8px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--surface);
  color:var(--text)
}
button{
  cursor:pointer;
  background:var(--btn);
  color:#fff;
  border:none
}
.btn-gray{background:var(--surface);color:var(--text)}
.pill{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:999px;
  padding:6px 10px;
  display:inline-flex;
  gap:6px;
  align-items:center
}
.muted{color:var(--muted);font-size:.92rem}
.badge-status{
  margin-left:8px;
  padding:2px 10px;
  border-radius:999px;
  font-size:.9rem;
  border:1px solid var(--border);
  display:none
}
.badge-ok{color:var(--ok)}
.badge-bad{color:var(--bad)}
.progressbar{
  height:8px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:999px;
  overflow:hidden
}
.progressbar > div{
  height:100%;
  background:var(--btn);
  width:0%
}


/* ===== Image cockpit ===== */
#imageWrapper{
  margin-top:10px;
  border-radius:12px;
  overflow:hidden;
  background:var(--surface);
  border:1px solid var(--border);
}

/* Conteneur interne avec ratio fixe (16:9) */
#imageWrapperInner{
  position:relative;
  width:100%;
  /* 16:9 ‚Üí 9/16 = 0.5625 ‚Üí 56.25% */
  padding-top:56.25%;
}

/* L'image remplit le conteneur interne, avec object-fit:contain */
#cockpitImg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  cursor:crosshair;
}

/* Le petit marker de clic et le cercle de s√©lection restent en position:absolute dans ce m√™me rep√®re */
#clickMarker,
#selectionMarker{
  /* ils sont d√©j√† en position:absolute, donc rien √† changer ici */
}


/* Optionnel : petit marqueur de clic pour le debug */
#clickMarker{
  position:absolute;
  width:14px;
  height:14px;
  margin:-7px 0 0 -7px;
  border-radius:50%;
  border:2px solid #fff;
  box-shadow:0 0 0 2px rgba(37,99,235,.8);
  pointer-events:none;
  display:none;
}
#imageWrapperInner{
  position:relative;
}

/* R√©sum√© simple en bas (facultatif) */
#summaryCard{margin-top:10px}
</style>
</head>
<body>
  <div class="card main">
    <!-- En-t√™te identique -->
    <div class="row" style="justify-content:space-between">
      <h1>‚úàÔ∏è Test Cockpit Cliquable</h1>
      <button id="themeToggle" class="btn-gray" title="Changer de th√®me">üåô/‚òÄÔ∏è</button>
    </div>

    <!-- Outils (pseudo / timer / score) -->
    <div class="row">
      <div style="min-width:160px">
        <label class="small">Pseudo</label>
        <input id="pseudoInput" placeholder="Ton nom" maxlength="20" />
      </div>

      <div class="pill"><span>‚è±Ô∏è</span><b id="timer">0</b>s</div>
      <div class="pill">Score: <b id="score">0</b></div>
    </div>

    <!-- Carte principale : question + image -->
    <div class="card" style="margin-top:10px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-size:1.2rem;font-weight:700">
          <span id="progressTxt">Sc√®ne 0/0</span>
          <span id="prevBadge" class="badge-status">OK</span>
        </div>
        <div class="progressbar" style="flex:1;max-width:360px">
          <div id="progressBar"></div>
        </div>
      </div>

      <p id="question" style="font-size:1.25rem;font-weight:700;margin:8px 0">
        Clique sur D√©marrer
      </p>

      <div id="imageWrapper">
        <div id="imageWrapperInner">
          <!-- ‚ö†Ô∏è remplace les chemins des images par les tiens -->
          <img id="cockpitImg" src="../images/kc135.jpg" alt="Cockpit interactif">
          <div id="clickMarker"></div>      <!-- petit point de debug -->
          <div id="selectionMarker"></div>  <!-- cercle jaune ray√© -->
        </div>
      </div>

      <div id="feedback" class="muted" style="min-height:28px;margin-top:6px">
        Clique sur une zone quand le test est d√©marr√©.
      </div>

      <div class="row" style="margin-top:8px">
        <button id="startBtn">D√©marrer</button>
        <button id="validateBtn" class="btn-gray" disabled>Valider</button>
        <button id="backBtn" class="btn-gray" style="display:none; margin-left:8px;">Retour</button>
        <button id="resetBtn" class="btn-gray">R√©initialiser</button>
      </div>
    </div>

    <!-- R√©sum√© tr√®s simple -->
    <div id="summaryCard" class="card" style="margin-top:10px;display:none">
      <h3 style="margin:0 0 6px">R√©sum√©</h3>
      <div id="summaryStats" class="muted"></div>
      <div id="summaryList" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

<script>
// ========= Helpers basiques (reprise de ta page) =========
const $ = s => document.querySelector(s);
const pad2 = n => String(n).padStart(2,'0');
const nowStamp = () => {
  const d=new Date();
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
};

// ========= Th√®me identique =========
const THEME_KEY='ata_theme';
(function applyTheme(){
  const t = localStorage.getItem(THEME_KEY)||'dark';
  document.documentElement.setAttribute('data-theme', t==='light'?'light':'dark');
})();
$('#themeToggle').onclick=()=>{
  const cur=document.documentElement.getAttribute('data-theme')==='light'?'light':'dark';
  const nxt=cur==='light'?'dark':'light';
  document.documentElement.setAttribute('data-theme',nxt);
  localStorage.setItem(THEME_KEY,nxt);
};

// ========= DOM & √©tat =========
const questionEl = $('#question');
const imgEl = $('#cockpitImg');
const feedbackEl = $('#feedback');
const markerEl = $('#clickMarker');
const selectionEl = $('#selectionMarker');  // cercle jaune ray√©
let selectedInstrumentId = null;    // id de l'instrument choisi (ex: "hsi", "mcdu")
let selectedInstrumentZone = null;  // l'objet zone complet (x1,y1,x2,y2, label, etc.)
const validateBtn = $('#validateBtn');   // 
const progressTxt = $('#progressTxt');
const progressBar = $('#progressBar');
const scoreEl = $('#score');
const timerEl = $('#timer');
const prevBadge = $('#prevBadge');
const backBtn = $('#backBtn');


const pseudoInput = $('#pseudoInput');
pseudoInput.value = localStorage.getItem('cockpit_pseudo') || '';
pseudoInput.addEventListener('change', ()=>{
  localStorage.setItem('cockpit_pseudo', pseudoInput.value.trim());
});

let running = false;
let score = 0;
let currentSceneId = null;
let clickHistory = [];
let targetInstrumentId = 'hsi';          // doit correspondre √† zone.id dans la sc√®ne zoom
let targetInstrumentLabel = 'HSI';       // juste pour l'affichage texte

// ========= D√©finition des sc√®nes & zones =========
// ‚ö†Ô∏è Mets ici les vrais noms de tes images et les coordonn√©es r√©elles
// Coordonn√©es en pixels bas√©es sur la taille "naturelle" de l'image (naturalWidth / naturalHeight)
const SCENES = {
  overview: {
    id: 'overview',
    index: 0,
    total: 2,
    image: '../images/cockpit_overview.jpg',
    question: "O√π se trouve globalement le HSI ?",
zones: [
  // === MAIN PANEL : 3 morceaux avec le m√™me id ===

  // 1) Bande du haut (au-dessus du pedestal)
  {
    id: 'main_panel',
    label: 'Main Instrument Panel',
    x1: 458,
    y1: 553,
    x2: 687,
    y2: 765,          // üëà juste avant le d√©but du pedestal (703)
    next: 'main_panel_zoom'
  },

  // 2) Bas-gauche (sous le panel, √† gauche du pedestal)
  {
    id: 'main_panel',
    label: 'Main Instrument Panel',
    x1: 693,
    y1: 513,          // m√™me hauteur que le haut du pedestal
    x2: 901,          // limite gauche du pedestal
    y2: 678,          // bas du main panel
    next: 'main_panel_zoom'
  },

  // 3) Bas-droite (sous le panel, √† droite du pedestal)
  {
    id: 'main_panel',
    label: 'Main Instrument Panel',
    x1: 909,          // limite droite du pedestal
    y1: 525,
    x2: 1125,
    y2: 788,
    next: 'main_panel_zoom'
  },

  // === PEDESTAL : en un seul bloc au centre ===
  {
    id: 'pedestal',
    label: 'Pedestal',
    x1: 702,
    y1: 698,
    x2: 926,
    y2: 1185,
    next: 'pedestal_zoom'   // ou null si tu n‚Äôas pas (encore) d‚Äôimage zoom pedestal
  }
]

  },

  // (on mettra ensuite main_panel_zoom ici)
    main_panel_zoom: {
    id: 'main_panel_zoom',
    index: 1,
    total: 2,
    image: '../images/main_panel_zoom.jpg', // √† adapter
    question: "Clique pr√©cis√©ment sur le HSI",
    zones: [
     {
        id: 'hsi',                    // üëà m√™me id
        label: 'HSI pilote',
        x1: 678, y1: 1017,  x2: 980, y2: 1347,
        next: null
      },
     {
        id: 'hsi',                    // üëà m√™me id
        label: 'HSI copilote',
        x1: 2801, y1: 1022,  x2: 3159, y2: 1333,
        next: null
      },
      {
        id: 'pfd',
        label: 'PFD pilote',
        x1: 641, y1: 664, x2: 962, y2: 994,
        next: null,
        isSolution: false
      },
      {
        id: 'pfd',
        label: 'PFD copilote',
        x1: 2815, y1: 674, x2: 3196, y2: 994,
        next: null,
        isSolution: false
      }
    ]
  },
   // (on mettra ensuite main_panel_zoom ici)
    pedestal_zoom: {
    id: 'pedestal_zoom',
    index: 1,
    total: 2,
    image: '../images/pedestal.jpg', // √† adapter
    question: "Clique pr√©cis√©ment sur le HSI",
    zones: [
     {
        id: 'mcdu',                    // üëà m√™me id
        label: 'mcdu pilote',
        x1: 936, y1: 87,  x2: 1067, y2: 820,
        next: null
      },
     {
        id: 'mcdu',                    // üëà m√™me id
        label: 'mcdu copilote',
        x1: 1212, y1: 106,  x2: 1352, y2: 839,
        next: null
      },
      {
        id: 'rudder trim',
        label: 'rudder trim ',
        x1: 1053, y1: 3560, x2: 1240, y2: 4042,
        next: null,
        isSolution: false
      },
      {
        id: 'flap',
        label: 'flap',
        x1: 1211, y1: 2499, x2: 1246, y2: 3329,
        next: null,
        isSolution: false
      }
    ]
  }
};


// ========= Fonctions utilitaires =========
function setProgress(scene){
  if(!scene){ progressTxt.textContent='Sc√®ne 0/0'; progressBar.style.width='0%'; return; }
  const idx = scene.index+1;
  const total = scene.total;
  progressTxt.textContent = `Sc√®ne ${idx}/${total}`;
  const pct = total ? (idx/total)*100 : 0;
  progressBar.style.width = `${pct}%`;
}

function showBadge(kind, text){
  prevBadge.className = 'badge-status';
  if(!kind){ prevBadge.style.display='none'; return; }
  prevBadge.style.display='inline-block';
  prevBadge.textContent = text || (kind === 'ok' ? 'OK' : 'FAUX');
  prevBadge.classList.add(kind === 'ok' ? 'badge-ok' : 'badge-bad');
  setTimeout(()=>{ prevBadge.style.display='none'; }, 1500);
}

function showMarker(x, y){
  markerEl.style.left = x+'px';
  markerEl.style.top = y+'px';
  markerEl.style.display = 'block';
  setTimeout(()=>{ markerEl.style.display='none'; }, 600);
}

function showSelectionOnZone(zone){
  if(!zone || !imgEl.naturalWidth) return;

  const rect = imgEl.getBoundingClientRect();
  const scaleX = rect.width / imgEl.naturalWidth;
  const scaleY = rect.height / imgEl.naturalHeight;

  // centre de la zone en coordonn√©es image
  const cxImg = (zone.x1 + zone.x2) / 2;
  const cyImg = (zone.y1 + zone.y2) / 2;

  // taille de la zone (pour adapter le diam√®tre du cercle)
  const wImg = zone.x2 - zone.x1;
  const hImg = zone.y2 - zone.y1;
  const baseRadiusImg = Math.min(wImg, hImg) / 2;

  // conversion en coordonn√©es affichage (taille r√©elle √† l'√©cran)
  const cxDisp = cxImg * scaleX;
  const cyDisp = cyImg * scaleY;
  const rDisp = baseRadiusImg * ((scaleX + scaleY)/2) * 0.8; // ~80% de la zone

  const size = Math.max(40, Math.min(200, rDisp * 2)); // limite min/max du cercle

  selectionEl.style.width = size + 'px';
  selectionEl.style.height = size + 'px';

  // centrage
  selectionEl.style.left = cxDisp + 'px';
  selectionEl.style.top  = cyDisp + 'px';
  selectionEl.style.marginLeft = (-size/2) + 'px';
  selectionEl.style.marginTop  = (-size/2) + 'px';

  selectionEl.style.display = 'block';
}

function clearSelection(){
  selectedInstrumentId = null;
  selectedInstrumentZone = null;
  selectionEl.style.display = 'none';
}

// Convertit le clic dans l'image visible ‚Üí coordonn√©es dans l'image r√©elle
function getImageClickCoords(event){
  const rect = imgEl.getBoundingClientRect();
  const iw = imgEl.naturalWidth;
  const ih = imgEl.naturalHeight;
  const rw = rect.width;
  const rh = rect.height;

  if (!iw || !ih || !rw || !rh) {
    return { x: 0, y: 0, xDisplay: 0, yDisplay: 0 };
  }

  // L'image est "contain" dans le rect ‚Üí on calcule l'√©chelle r√©elle
  const scale = Math.min(rw / iw, rh / ih);
  const displayWidth  = iw * scale;
  const displayHeight = ih * scale;

  // Marges (barres) autour de l'image dans le rect
  const offsetX = (rw - displayWidth)  / 2;
  const offsetY = (rh - displayHeight) / 2;

  // Coordonn√©es du clic dans le rep√®re du rect
  const px = event.clientX - rect.left;
  const py = event.clientY - rect.top;

  // Coordonn√©es du clic dans le rep√®re de l'image affich√©e (sans les marges)
  const pxInImg = px - offsetX;
  const pyInImg = py - offsetY;

  // Si on clique dans les marges (en dehors de l'image r√©elle) ‚Üí on peut consid√©rer hors zone
  if (pxInImg < 0 || pyInImg < 0 || pxInImg > displayWidth || pyInImg > displayHeight) {
    return { x: -1, y: -1, xDisplay: px, yDisplay: py };
  }

  // Conversion vers coordonn√©es "naturelles" de l'image (tes zones)
  const x = pxInImg / scale;
  const y = pyInImg / scale;

  return {
    x,
    y,
    xDisplay: px,
    yDisplay: py
  };
}


function findZone(scene, x, y){
  if(!scene || !scene.zones) return null;
  return scene.zones.find(z =>
    x >= z.x1 && x <= z.x2 &&
    y >= z.y1 && y <= z.y2
  );
}

// ========= Logique principale =========
function loadScene(id){
  const scene = SCENES[id];
  if(!scene){
    console.warn('Scene inconnue:', id);
    return;
  }
  currentSceneId = id;
  // === Bouton Retour : visible uniquement dans les sc√®nes zoom ===
if (id === "overview") {
    backBtn.style.display = "none";
} else {
    backBtn.style.display = "inline-block";
}

  questionEl.textContent = scene.question;
  imgEl.src = scene.image;
  feedbackEl.textContent = "Clique dans l'image pour r√©pondre.";
  setProgress(scene);
}

function startTest(){
  running = true;
  score = 0;
  clickHistory = [];
  scoreEl.textContent = '0';
  timerEl.textContent = '0';
  if (validateBtn) {
    validateBtn.disabled = true;
  }
  loadScene('overview');
}


function resetTest(){
  running = false;
  currentSceneId = null;
  clickHistory = [];
  questionEl.textContent = 'Clique sur D√©marrer';
  imgEl.src = '../images/kc135.jpg';
  feedbackEl.textContent = 'Clique sur une zone quand le test est d√©marr√©.';
  setProgress(null);
  $('#summaryCard').style.display='none';
  markerEl.style.display='none';
  showBadge(null);
  clearSelection();

  if (validateBtn) {
    validateBtn.disabled = true;
  }
}


function finishTest(){
  running = false;
  feedbackEl.innerHTML = `<span class="muted">Test termin√©.</span>`;
  const pseudo = (pseudoInput.value || 'Anonyme').trim();
  const totalClicks = clickHistory.length;
  const goodClicks = clickHistory.filter(c => c.isSolution).length;

  $('#summaryStats').innerHTML =
    `Joueur : <b>${pseudo}</b> ‚Äì Score : <b>${score}</b> ‚Äì Clics corrects : <b>${goodClicks}</b> / ${totalClicks}`;

  $('#summaryList').innerHTML = clickHistory.map((c, idx) => {
    const cls = c.isSolution ? 'ok' : 'bad';
    const lab = c.zoneLabel || '(hors zone)';
    return `<div class="${cls}">#${idx+1} ‚Äì ${c.scene} : ${lab} <span class="muted">(${Math.round(c.x)};${Math.round(c.y)})</span></div>`;
  }).join('') || '<span class="muted">Aucun clic enregistr√©.</span>';

  $('#summaryCard').style.display='block';
}

// ========= Gestion du clic sur l'image =========
imgEl.addEventListener('click', (e)=>{
  if(!running || !currentSceneId || !imgEl.naturalWidth) return;

  const scene = SCENES[currentSceneId];
  const { x, y, xDisplay, yDisplay } = getImageClickCoords(e);
  if (x < 0 || y < 0) {
  // clic en dehors de l'image r√©elle (dans les bandes/marges)
  feedbackEl.innerHTML = `<span class="muted">Clique dans l'image, pas dans le cadre autour.</span>`;
  return;
}


  // petit point de debug (tu peux le d√©sactiver plus tard si tu veux)
  showMarker(xDisplay, yDisplay);

  console.log('Click image coords:', Math.round(x), Math.round(y));
  feedbackEl.innerHTML = `Clic : <b>${Math.round(x)}</b> ; <b>${Math.round(y)}</b>`;

  const zone = findZone(scene, x, y);

  if(!zone){
    feedbackEl.innerHTML = `<span class="muted">En dehors des zones d√©finies.</span>`;
    showBadge('bad', 'Hors zone');
    return;
  }

  // 1) Si la zone pointe vers une autre sc√®ne ‚Üí navigation / zoom
  if(zone.next){
    clearSelection(); // si on avait d√©j√† un instrument s√©lectionn√©, on efface
    feedbackEl.innerHTML = `Zone : <b>${zone.label}</b><br><span class="muted">Zoom sur cette zone...</span>`;
    showBadge('ok', 'Zoom');
    setTimeout(()=> loadScene(zone.next), 300);
    return;
  }

  // 2) Sinon : on consid√®re que c'est un INSTRUMENT s√©lectionnable
  selectedInstrumentId = zone.id;
  selectedInstrumentZone = zone;

  // affiche le cercle jaune ray√© sur cette zone
  showSelectionOnZone(zone);

  // petit message pour guider l'utilisateur
  feedbackEl.innerHTML = `<span class="muted">Clique sur "Valider" pour confirmer ta r√©ponse.</span>`; //Instrument s√©lectionn√© : <b>${zone.label}</b><br>
  // showBadge('ok', 'Choix');

  // (optionnel) si on a d√©j√† un bouton Valider, on l'active
  const validateBtn = document.querySelector('#validateBtn');
  if(validateBtn){
    validateBtn.disabled = false;
  }
});


// ========= Boutons =========
$('#startBtn').onclick = () => {
  resetTest();
  startTest();
};
$('#resetBtn').onclick = () => {
  resetTest();
};
validateBtn.addEventListener('click', ()=>{
  if (!running) return;

  if (!selectedInstrumentId || !selectedInstrumentZone) {
    feedbackEl.innerHTML = `<span class="muted">Clique d'abord sur un instrument pour le s√©lectionner.</span>`;
    showBadge('bad', 'Aucun choix');
    return;
  }

  // Comparaison avec l'instrument cible
  if (selectedInstrumentId === targetInstrumentId) {
    // ‚úÖ Bonne r√©ponse
    score++;
    scoreEl.textContent = score;
    feedbackEl.innerHTML =
      `<span class="ok"><b>Bonne r√©ponse !</b></span><br>` +
      `Tu as bien trouv√© : <b>${selectedInstrumentZone.label}</b>`;
    showBadge('ok', 'OK');
  } else {
    // ‚ùå Mauvaise r√©ponse
    feedbackEl.innerHTML =
      `<span class="bad"><b>Mauvaise r√©ponse.</b></span><br>` +
      `Tu as cliqu√© : <b>${selectedInstrumentZone.label}</b><br>` +
      `R√©ponse attendue : <b>${targetInstrumentLabel}</b>`;
    showBadge('bad', 'FAUX');
  }

  // Une fois valid√© : on d√©sactive le bouton, on pourrait ensuite passer √†
  // une autre question ou remettre la m√™me.
  validateBtn.disabled = true;
  clearSelection();

  // Ici tu peux soit :
  // - lancer une nouvelle question (changer targetInstrumentId + loadScene('overview'))
  // - soit afficher un r√©sum√© / continuer √† la main
});
backBtn.addEventListener('click', () => {
    loadScene("overview");
    feedbackEl.textContent = "";
    hideSelectionMarker();  // si tu as cette fonction sinon tu m‚Äôavises
    selectedInstrumentId = null;
    validateBtn.disabled = true;
});


// ========= Boot =========
(function boot(){
  setProgress(null);
  timerEl.textContent = '0';
})();
</script>
</body>
</html>
