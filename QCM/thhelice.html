<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Th H√©lice</title>
<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --ok:#22c55e;
  --bof:#fbbf24;
  --bad:#ef4444;
  --btn:#2563eb;
  --surface:#0b1223;
  --border:#334155;
}
/* ===== Palette inspir√©e du logo Sabena technics ===== */
:root[data-theme="light"]{
  --bg:#f5f7fa;
  --card:#ffffff;
  --text:#111827;           /* Texte principal : noir anthracite */
  --muted:#374151;          /* Sous-titres : gris fonc√© */
  --ok:#007A33;             /* Vert Sabena (validation) */
  --bof:#FFD200;            /* Jaune Sabena */
  --bad:#C1121F;            /* Rouge profond (erreur) */
  --btn:#003366;            /* Bleu Sabena */
  --surface:#f0f4f8;        /* Fond clair homog√®ne */
  --border:#cbd5e1;         /* Bordures neutres */
}

:root[data-theme="light"] .opt{
  color: var(--text);
  background:#ffffff;
  border-color: var(--border);
}
:root[data-theme="light"] .opt:hover,
:root[data-theme="light"] .opt:focus{
  outline: 2px solid var(--btn);
  background: color-mix(in srgb, var(--btn) 6%, #fff);
}
:root[data-theme="light"] .opt.correct{
  outline-color: var(--ok);
  background: color-mix(in srgb, var(--ok) 15%, #fff);
  color: var(--text);
}
:root[data-theme="light"] .opt.wrong{
  outline-color: var(--bad);
  background: color-mix(in srgb, var(--bad) 10%, #fff);
  color: var(--text);
}
:root[data-theme="light"] .badge-status.badge-ok{ color: var(--ok); }
:root[data-theme="light"] .badge-status.badge-bof{ color: var(--bof); }
:root[data-theme="light"] .badge-status.badge-bad{ color: var(--bad); }

:root[data-theme="light"] button{ background: var(--btn); color: #fff; }
:root[data-theme="light"] .btn-gray{ background: var(--surface); color: var(--text); }

html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,sans-serif;
  padding:16px;
  display:flex;
  justify-content:center;   /* ‚úÖ centre horizontalement */
  align-items:flex-start;    /* garde le haut visible (√©vite centrage vertical complet) */
  min-height:100vh;          /* occupe toute la hauteur de la fen√™tre */
}

.card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.15);padding:16px}
.main{
  width:100%;
  max-width:900px;
}

.side{width:340px;min-width:300px;max-height:90vh;overflow:auto;display:flex;flex-direction:column;gap:12px}
h1{margin:0 0 10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select,input,button{padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text)}
button{cursor:pointer;background:var(--btn);color:#fff;border:none}
.btn-gray{background:var(--surface);color:var(--text)}
.pill{background:var(--surface);border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;gap:6px;align-items:center}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.opt{
  background:var(--surface);border:1px solid var(--btn);border-radius:10px;
  padding:14px 16px;cursor:pointer;text-align:left;font-size:1.05rem;font-weight:600;
  transition:transform .12s ease
}
.opt:hover{transform:scale(1.02)}
.opt.correct{outline:2px solid var(--ok);background:rgba(34,197,94,.12)}
.opt.wrong{outline:2px solid var(--bad);background:rgba(239,68,68,.12)}
.muted{color:var(--muted);font-size:.92rem}
.timer{background:var(--surface);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
.badge{background:var(--surface);border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:.8rem}
.badge-status{margin-left:8px;padding:2px 10px;border-radius:999px;font-size:.9rem;border:1px solid var(--border);display:none}
.badge-ok{color:var(--ok)}
.badge-bof{color:var(--bof)}
.badge-bad{color:var(--bad)}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
th{color:var(--muted)}
.log{background:var(--surface);padding:10px;border-radius:8px;height:300px;overflow:auto}
.ok{color:var(--ok)} .bof{color:var(--bof)} .bad{color:var(--bad)}
.hl{font-weight:700;text-decoration:underline}
.progressbar{height:8px;background:var(--surface);border:1px solid var(--border);border-radius:999px;overflow:hidden}
.progressbar > div{height:100%;background:var(--btn);width:0%}
.svg-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:8px}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.small{font-size:.9rem}
@media (max-width:640px){
  .grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
  <div class="card main">
    <div class="row" style="justify-content:space-between">
      <h1>‚úàÔ∏è Th H√©lice</h1>
      <button id="themeToggle" class="btn-gray" title="Changer de th√®me">üåô/‚òÄÔ∏è</button>
    <button id="homeBtn" class="btn-gray" title="Retour √† l'accueil">üè† Accueil</button>
    </div>
    <script>
    document.getElementById("homeBtn").addEventListener("click", () => {
    window.location.href = "https://adpmt.github.io/QCM-ADPMT/";
    });
    </script>
    <!-- Outils -->
    <div class="row">
      <div style="min-width:160px">
        <label class="small">Pseudo</label>
        <input id="pseudoInput" placeholder="Ton nom" maxlength="20" />
      </div>

      <div class="pill"><span>‚è±Ô∏è</span><b id="timer">0</b>s</div>
      <div class="pill">Score: <b id="score">0</b></div>
    </div>

    <!-- Question -->
    <div class="card" style="margin-top:10px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-size:1.2rem;font-weight:700">
          <span id="progressTxt">Question 0/0</span>
          <span id="prevBadge" class="badge-status">OK</span>
        </div>
        <div class="progressbar" style="flex:1;max-width:360px">
          <div id="progressBar"></div>
        </div>
      </div>
      <p id="question" style="font-size:1.25rem;font-weight:700;margin:8px 0">Clique sur D√©marrer</p>
      <div id="choices" class="grid"></div>
      <div id="feedback" class="muted" style="min-height:28px;margin-top:6px"></div>

      <div class="row" style="margin-top:8px">
        <button id="startBtn">D√©marrer</button>
        <button id="pauseBtn" class="btn-gray" disabled>Pause</button>
        <button id="stopBtn" class="btn-gray" disabled>Stop</button>
        <button id="resumeBtn" class="btn-gray" style="display:none">Reprendre</button>
      </div>
    </div>

    <!-- R√©sum√© -->
    <div id="summaryCard" class="card" style="margin-top:10px;display:none">
      <h3 style="margin:0 0 6px">R√©sum√©</h3>
      <div id="summaryStats" class="muted"></div>
      <div id="summaryList" class="muted" style="height:220px;overflow:auto;margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <button id="printSummary" class="btn-gray">Imprimer</button>
        <button id="closeSummary" class="btn-gray">Fermer</button>
      </div>
    </div>

<div id="scoreBoardCard" class="card" style="margin-top:10px">
  <h3 style="margin:0 0 6px">Tableau des scores</h3>
  <div class="muted small">Affiche les 10 derniers (stocke 30 max).</div>
  <table>
    <thead>
      <tr><th>Pseudo</th><th>Score</th><th>%</th><th>Date</th></tr>
    </thead>
    <tbody id="scoreTableBody"></tbody>
  </table>
  <div class="row" style="margin-top:6px">
    <button id="clearScores" class="btn-gray">Effacer</button>
  </div>
</div>

    <!-- Progression -->
    <div class="card" style="margin-top:10px">
      <h3 style="margin:0 0 6px">üìà Progression</h3>
      <div class="svg-wrap"><svg id="chart" viewBox="0 0 320 120" width="100%" height="120" aria-label="Courbe des %"></svg></div>
    </div>
  </div>



<script>
// ====== Helpers
const $ = s => document.querySelector(s);
const pad2 = n => String(n).padStart(2,'0');
const nowStamp = () => { const d=new Date(); return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

// ====== Th√®me
const THEME_KEY='ata_theme';
(function applyTheme(){
  const t = localStorage.getItem(THEME_KEY)||'dark';
  document.documentElement.setAttribute('data-theme', t==='light'?'light':'dark');
})();
$('#themeToggle').onclick=()=>{
  const cur=document.documentElement.getAttribute('data-theme')==='light'?'light':'dark';
  const nxt=cur==='light'?'dark':'light';
  document.documentElement.setAttribute('data-theme',nxt);
  localStorage.setItem(THEME_KEY,nxt);
};

// ====== Storage keys
const LS_SCORES='helice_scores_v2';
const LS_PSEUDO='helice_pseudo_v2';
const LS_SNAPSHOT='helice_snapshot_v1';

// ====== √âtat
let running=false, paused=false, i=0, score=0;
let questionOrder=[], filteredQuestions=[];
let timeLeft=0, tickHandle=null, mode='TRAIN', perQ=15;
let answersLog=[];

// ====== DOM
const qEl=$('#question'), choicesEl=$('#choices'), feedbackEl=$('#feedback');
const timerEl=$('#timer'), scoreEl=$('#score'), progressTxt=$('#progressTxt'), progressBar=$('#progressBar');
const pseudoInput=$('#pseudoInput'); pseudoInput.value=localStorage.getItem(LS_PSEUDO)||'';
pseudoInput.addEventListener('change',()=>localStorage.setItem(LS_PSEUDO,pseudoInput.value.trim()));

// ====== Questions (exemple) ‚Äî remplace/compl√®te par ta liste compl√®te si besoin
let QUESTIONS = [
  { "q": "Le r√¥le principal d‚Äôune h√©lice sur un avion est :", "choices": ["Transformer l‚Äô√©nergie m√©canique du moteur en force de traction", "G√©n√©rer de la portance comme une aile", "Freiner l‚Äôavion lors de l‚Äôatterrissage", "Refroidir le moteur en vol"], "answer": 0 },
  { "q": "Pour qu‚Äôune pale d‚Äôh√©lice g√©n√®re une force utile, il faut :", "choices": ["Qu‚Äôelle soit align√©e avec le vent relatif", "Qu‚Äôelle tourne √† tr√®s basse vitesse", "Une surface profil√©e, un vent relatif et un angle d‚Äôincidence", "Qu‚Äôelle reste immobile"], "answer": 2 },
  { "q": "Le calage d‚Äôune h√©lice correspond √† :", "choices": ["L‚Äôangle entre la pale et le vent relatif", "L‚Äôangle entre la corde de la pale et le plan de rotation", "L‚Äôangle entre le cordeau et le niveau", "L‚Äôangle de roulis de l‚Äôavion"], "answer": 1 },
  { "q": "Le vrillage d‚Äôune pale sert √† :", "choices": ["R√©duire le bruit", "Am√©liorer le freinage", "Emp√™cher la pale de chauffer", "Compenser les diff√©rences de vitesse entre pied et extr√©mit√© de pale"], "answer": 3 },
  { "q": "L‚Äôangle de calage de r√©f√©rence d‚Äôune pale est mesur√© :", "choices": ["√Ä 70% du rayon de la pale", "En bout de pale", "Au niveau du moyeu", "Au centre du c√¥ne"], "answer": 0 },
  { "q": "Le pas th√©orique d‚Äôune h√©lice correspond √† :", "choices": ["La force de portance d‚Äôune pale", "La diff√©rence de pression avant/arri√®re", "La distance que parcourrait l‚Äôh√©lice sans glissement par tour", "La distance entre deux pales"], "answer": 2 },
  { "q": "Le pas r√©el d‚Äôune h√©lice d√©pend :", "choices": ["Uniquement du nombre de pales", "De la temp√©rature ext√©rieure", "De la vitesse avion et de la vitesse de rotation", "De la masse carburant"], "answer": 2 },
  { "q": "Le recul de l‚Äôh√©lice correspond :", "choices": ["Au bruit per√ßu", "√Ä la vibration du fuselage", "√Ä la diff√©rence entre calage sol et vol", "√Ä l‚Äô√©cart entre pas th√©orique et r√©el"], "answer": 3 },
  { "q": "Le rendement d‚Äôune h√©lice se d√©finit comme :", "choices": ["Chaleur dissip√©e par le moyeu", "Puissance perdue en frottement", "Rapport puissance utile / puissance absorb√©e", "Rapport pouss√©e/poids"], "answer": 2 },
  { "q": "Une h√©lice √† pas fixe a un rendement maximal :", "choices": ["√Ä n‚Äôimporte quelle vitesse", "√Ä une vitesse propre donn√©e", "Seulement au d√©collage", "Seulement en descente"], "answer": 1 },
  { "q": "Lors du d√©collage avec une h√©lice √† pas fixe :", "choices": ["Le moteur cale", "Le rendement est optimal", "Le moteur est en survitesse", "Le rendement diminue et le moteur est en sous-r√©gime"], "answer": 3 },
  { "q": "En descente rapide, une h√©lice √† pas fixe :", "choices": ["A un rendement parfait", "Le couple devient nul", "Le moteur peut partir en sur-r√©gime", "Se bloque m√©caniquement"], "answer": 2 },
  { "q": "On r√©duit le r√©gime transmis √† l‚Äôh√©lice pour :", "choices": ["Faire chauffer l‚Äôhuile", "√âviter les vitesses transsoniques en bout de pale", "Emp√™cher l‚Äôavion d‚Äôacc√©l√©rer", "D√©sactiver la traction"], "answer": 1 },
  { "q": "Une h√©lice √† petit pas est avantageuse pour :", "choices": ["Le d√©collage et la mont√©e", "La croisi√®re rapide", "Le freinage", "Le vol supersonique"], "answer": 0 },
  { "q": "Une h√©lice √† grand pas est avantageuse pour :", "choices": ["Le roulage", "Le freinage", "La croisi√®re rapide et √©conomique", "Le stationnaire"], "answer": 2 },
  { "q": "Une h√©lice √† pas fixe :", "choices": ["Change d‚Äôangle automatiquement", "A un pas bloqu√© m√©caniquement", "Varie avec l‚Äôhydraulique", "D√©pend du vent"], "answer": 1 },
  { "q": "Une h√©lice √† pas variable :", "choices": ["A des pales repliables", "Permet de modifier le calage pour optimiser le rendement", "Se d√©forme sous le bruit", "A un c√¥ne qui tourne ind√©pendamment"], "answer": 1 },
  { "q": "On compare une h√©lice √† pas variable √† une bo√Æte de vitesses car :", "choices": ["Elle lubrifie le moteur", "Elle freine l‚Äôavion", "Elle cr√©e de l‚Äô√©lectricit√©", "Elle adapte le pas comme un rapport de bo√Æte"], "answer": 3 },
  { "q": "Les pales modernes sont g√©n√©ralement :", "choices": ["En composite avec protection nickel et mousse interne", "En papier compress√©", "En bois massif", "En b√©ton fibr√©"], "answer": 0 },
  { "q": "Le bord d‚Äôattaque nickel√© d‚Äôune pale sert √† :", "choices": ["√âquilibrer l‚Äôavion", "Rendre la pale transparente au radar", "Refroidir le moteur", "Prot√©ger contre l‚Äô√©rosion"], "answer": 3 },
  { "q": "Le chauffage des pales d‚Äôh√©lice sert √† :", "choices": ["√âviter les vibrations", "Augmenter la pouss√©e", "D√©givrer radialement la pale", "Chauffer la cabine"], "answer": 2 },
  { "q": "Le moyeu d‚Äôh√©lice :", "choices": ["Contient les freins", "Sert de r√©servoir carburant", "Est purement d√©coratif", "Relie m√©caniquement les pales et peut √™tre car√©n√©"], "answer": 3 },
  { "q": "L‚Äôactionneur de changement de pas permet :", "choices": ["De changer le pas des pales", "De verrouiller la gouverne", "De freiner l‚Äôh√©lice", "De mesurer la vitesse avion"], "answer": 0 },
  { "q": "La vanne de changement de pas oriente :", "choices": ["L‚Äôair des pneus", "L‚Äôhuile vers les chambres inc/d√©c pas", "Le carburant cabine", "Les gaz d‚Äô√©chappement"], "answer": 1 },
  { "q": "La vis de pitchlock sert √† :", "choices": ["D√©ployer les volets", "Positionner la vanne de changement de pas", "Bloquer la direction", "Couper le moteur"], "answer": 1 },
  { "q": "Quand la vis de pitchlock tourne antihoraire :", "choices": ["Les pales rentrent", "Le moteur s‚Äô√©teint", "Le pas augmente", "Le feu moteur s‚Äôactive"], "answer": 2 },
  { "q": "Quand l‚Äôhuile arrive c√¥t√© 'augmentation de pas' :", "choices": ["Le calage diminue", "Les pales vont en drapeau complet", "Le moteur s‚Äôarr√™te", "Les pales prennent un angle plus grand"], "answer": 3 },
  { "q": "La position feather sert √† :", "choices": ["Maximiser la tra√Æn√©e", "Mettre la pale parall√®le au vent en cas de panne", "R√©chauffer le carburant", "Stabiliser le roulage"], "answer": 1 },
  { "q": "La variation de pas sur turbopropulseur sert √† :", "choices": ["Optimiser la traction et l‚Äôefficacit√© selon la phase de vol", "Voler sans train", "Couper la gouverne", "Supprimer le bruit"], "answer": 0 },
  { "q": "Le c√¥ne d‚Äôh√©lice (spinner) :", "choices": ["Ne tourne jamais", "Car√®ne le moyeu pour l‚Äôa√©rodynamique", "Capte la temp√©rature cabine", "Est une antenne radio"], "answer": 1 },
  { "q": "Une h√©lice tireuse :", "choices": ["Est mont√©e devant le moteur et tire l‚Äôavion", "Est √† l‚Äôarri√®re du fuselage", "Est r√©serv√©e au supersonique", "Est utilis√©e au sol"], "answer": 0 },
  { "q": "Une h√©lice fonctionne comme :", "choices": ["Un a√©rofrein", "Un aileron", "Une aile en rotation cr√©ant une force vers l‚Äôavant", "Une pompe √† vide"], "answer": 2 },
  { "q": "Le vrillage permet :", "choices": ["Un angle d‚Äôattaque utile tout le long de la pale", "Une pale inutile en bout", "Une d√©co visuelle", "De r√©duire le bruit"], "answer": 0 },
  { "q": "La force de traction d‚Äôune h√©lice est :", "choices": ["N√©gligeable", "Inexistante en descente", "Uniquement au sol", "La force vers l‚Äôavant qui fait avancer l‚Äôavion"], "answer": 3 },
  { "q": "Contr√¥ler le r√©gime d‚Äôh√©lice sert √† :", "choices": ["Allumer les feux", "Vider les circuits", "Garder les extr√©mit√©s subsoniques", "Emp√™cher la rotation du compresseur"], "answer": 2 },
  { "q": "L‚Äôhuile utilis√©e pour changer le pas provient :", "choices": ["Du circuit carburant cabine", "D‚Äôun circuit hydraulique command√© par la PCU", "D‚Äôune bouteille d‚Äôair", "De la climatisation"], "answer": 1 },
  { "q": "Quand on augmente le pas en croisi√®re :", "choices": ["La pale mord plus d‚Äôair, le moteur tourne plus lentement", "Le moteur acc√©l√®re √† fond", "On perd la traction", "Le c√¥ne tombe"], "answer": 0 },
  { "q": "Le d√©placement de l‚Äôactionneur de pas provoque :", "choices": ["La coupure moteur", "Le d√©ploiement des volets", "Une modification d‚Äôangle de calage", "Le verrouillage du train"], "answer": 2 },
  { "q": "Le tube de transfert d‚Äôhuile :", "choices": ["Mesure la temp√©rature ext√©rieure", "Alimente le circuit carburant", "Transmet l‚Äôair conditionn√©", "Am√®ne l‚Äôhuile √† travers les pi√®ces tournantes"], "answer": 3 },
  { "q": "On dit qu‚Äôune h√©lice est une vis dans l‚Äôair car :", "choices": ["Elle ne tourne pas vraiment", "Elle avance d‚Äôune distance fixe par tour : son pas th√©orique", "Chaque pale est creuse", "Le filetage est identique √† une vis"], "answer": 1 }
];

// üëâ Tu peux coller ici ta grosse liste compl√®te : le code fonctionne pareil.

// ====== Scores (stock 30, affichage 10)
function loadScores(){ try{ return JSON.parse(localStorage.getItem(LS_SCORES)||'[]') }catch{ return [] } }
function saveScores(list){ localStorage.setItem(LS_SCORES, JSON.stringify(list.slice(-30))); }
function addScoreRow(entry){
  const pct = entry.total ? Math.round(entry.score/entry.total*1000)/10 : 0;
  const tr=document.createElement('tr');
  tr.innerHTML = `<td>${entry.name||'‚Äî'}</td><td>${entry.score}/${entry.total}</td><td>${pct}%</td><td>${entry.when}</td>`;
  $('#scoreTableBody').appendChild(tr);
}
function renderScoreTable(){
  const body=$('#scoreTableBody'); body.innerHTML='';
  const list=loadScores(); const view=list.slice(-10).reverse(); // 10 derniers, r√©cents en haut
  view.forEach(addScoreRow);
}
$('#clearScores').onclick=()=>{ localStorage.removeItem(LS_SCORES); renderScoreTable(); drawChart(); };

// ====== Graph progression (utilise jusqu‚Äô√† 30 entr√©es)
function drawChart(){
  const svg=$('#chart'); svg.innerHTML='';
  const list=loadScores(); const values=list.map(e=>Math.round(e.score/e.total*100));
  const N=values.length, W=320, H=120, pad=12;
  // axes
  const ax=document.createElementNS('http://www.w3.org/2000/svg','path');
  ax.setAttribute('d',`M${pad},${H-pad}H${W-pad} M${pad},${pad}V${H-pad}`);
  ax.setAttribute('stroke','currentColor'); ax.setAttribute('fill','none'); ax.setAttribute('opacity','0.4');
  svg.appendChild(ax);
  if(!N) return;
  const start=Math.max(0,N-20), arr=values.slice(start);
  const step=(W-2*pad)/Math.max(1,arr.length-1);
  const pts=arr.map((v,k)=>[pad+k*step,(H-pad)-(v/100)*(H-2*pad)]);
  const d=pts.map((p,k)=>(k?'L':'M')+p[0]+','+p[1]).join(' ');
  const path=document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d',d); path.setAttribute('fill','none'); path.setAttribute('stroke','currentColor');
  svg.appendChild(path);
}
renderScoreTable(); drawChart();

// ====== Timer
function clearTick(){ if(tickHandle){ clearInterval(tickHandle); tickHandle=null; } }
function setTimer(v){ timerEl.textContent=v; }
function startTick(){
  clearTick(); timeLeft=perQ; setTimer(timeLeft);
  tickHandle=setInterval(()=>{ if(paused) return; timeLeft--; setTimer(Math.max(0,timeLeft)); if(timeLeft<=0){ clearTick(); onTimeout(); } },1000);
}

// ====== Progress + badge
function renderProgress(){
  const total=filteredQuestions.length;
  progressTxt.textContent=`Question ${Math.min(i+1,total)}/${total}`;
  const pct = total? Math.round(i/total*100) : 0;
  progressBar.style.width = pct+'%';
}
function showBadge(kind){
  const el=$('#prevBadge'); el.className='badge-status';
  if(!kind){ el.style.display='none'; return; }
  el.style.display='inline-block';
  el.textContent = kind==='ok'?'OK':(kind==='bad'?'FAUX':'BOF');
  el.classList.add(kind==='ok'?'badge-ok':(kind==='bad'?'badge-bad':'badge-bof'));
  setTimeout(()=>{ el.style.display='none'; }, 1500);
}

// ====== Rendu question (m√©lange des r√©ponses)
function renderQuestion(){
  const total=filteredQuestions.length;
  if(i>=total){ finishGame(); return; }

  const current=filteredQuestions[questionOrder[i]];
  const shuffled = current.choices.map((text,idx)=>({text,idx})).sort(()=>Math.random()-0.5);
  current.shuffledMap = shuffled.map(o=>o.idx);
  current.shuffledAnswer = shuffled.findIndex(o=>o.idx===current.answer);

  qEl.textContent=current.q;
  renderProgress();
  feedbackEl.textContent='';
  choicesEl.innerHTML='';

  shuffled.forEach((item, idx)=>{
    const b=document.createElement('button');
    b.className='opt'; b.textContent=item.text;
    b.addEventListener('click', ()=> onSelect(idx, b));
    choicesEl.appendChild(b);
  });

  if(running && !paused) startTick();
}
function highlightGood(){
  const cur=filteredQuestions[questionOrder[i]];
  const good = (cur && typeof cur.shuffledAnswer==='number') ? cur.shuffledAnswer : cur.answer;
  document.querySelectorAll('.opt').forEach((b,idx)=>{ b.disabled=true; if(idx===good) b.classList.add('correct'); });
}
function disableAll(){ document.querySelectorAll('.opt').forEach(b=>b.disabled=true); }

// ====== S√©lection / Timeout
function onSelect(idx, btn){
  if(!running || paused) return;
  clearTick();
  const curQ=filteredQuestions[questionOrder[i]];
  const goodShuffled = (typeof curQ.shuffledAnswer==='number') ? curQ.shuffledAnswer : curQ.answer;
  const pickedOriginal = Array.isArray(curQ.shuffledMap) ? curQ.shuffledMap[idx] : idx;

  // log pour le r√©sum√©
  answersLog[i] = {
    index:i, q:curQ.q, choices:curQ.choices.slice(),
    correctIndex:curQ.answer, pickedIndex:pickedOriginal,
    correct:(idx===goodShuffled), timedOut:false
  };

  if(mode==='TRAIN'){
    highlightGood();
    if(idx===goodShuffled){
      score++; scoreEl.textContent=score;
      feedbackEl.innerHTML = `<span class="ok"><b>Bonne r√©ponse !</b></span>`;
      showBadge('ok');
    }else{
      btn.classList.add('wrong');
      feedbackEl.innerHTML = `<span class="bad"><b>Faux.</b></span>`;
      showBadge('bad');
    }
  }else{
    disableAll(); // examen : pas de correction imm√©diate
  }

  setTimeout(()=>{ i++; renderQuestion(); }, 800);
}
function onTimeout(){
  if(!running) return;
  const curQ=filteredQuestions[questionOrder[i]];
  answersLog[i] = {
    index:i, q:curQ.q, choices:curQ.choices.slice(),
    correctIndex:curQ.answer, pickedIndex:null, correct:false, timedOut:true
  };
  if(mode==='TRAIN'){
    highlightGood();
    feedbackEl.innerHTML = `<span class="muted"><b>Temps √©coul√©.</b></span>`;
    showBadge('bad');
  }else{
    disableAll();
  }
  setTimeout(()=>{ i++; renderQuestion(); }, 800);
}

// ====== S√©lection des questions
function buildFilteredQuestions(){
  // Utiliser TOUTES les questions disponibles
  const arr = shuffle(QUESTIONS.map((q, idx) => ({ q, idx })));
  filteredQuestions = arr.map(o => o.q);
  questionOrder = shuffle([...filteredQuestions.keys()]);
}


// ====== D√©marrer / Pause / Stop
function resetState(){
  running=false; paused=false; i=0; score=0; answersLog=[];
  scoreEl.textContent='0'; clearTick(); timerEl.textContent='0';
  progressBar.style.width='0%'; progressTxt.textContent='Question 0/0';
  qEl.textContent='Clique sur D√©marrer'; choicesEl.innerHTML=''; feedbackEl.textContent='';
  $('#summaryCard').style.display='none';
}
function startGame(fromSnapshot=false){
  mode = 'TRAIN';
  perQ = 15; // 10 secondes fixes par question	
  if(!fromSnapshot) buildFilteredQuestions();
  running=true; paused=false; i=0; score=0; answersLog=[];
  renderQuestion();
  $('#pauseBtn').disabled=false; $('#stopBtn').disabled=false;
  saveSnapshot();
}
$('#startBtn').onclick=()=>{ resetState(); startGame(false); };
$('#pauseBtn').onclick=()=>{
  if(!running) return;
  paused = !paused;
  $('#pauseBtn').textContent = paused? 'Reprendre' : 'Pause';
  if(!paused) startTick();
  saveSnapshot();
};
$('#stopBtn').onclick=()=> finishGame();

// ====== R√©sum√© + enregistrement du score
function recordFinalScore(){
  const name = (pseudoInput.value||'').trim() || 'Anonyme';
  const entry = { name, score, total: filteredQuestions.length, when: nowStamp() };

  // garder l'historique d√©taill√© pour ce QCM
  const list = loadScores();
  list.push(entry);
  saveScores(list);

  // calcul du pourcentage actuel
  const pct = entry.total ? (entry.score / entry.total * 100) : 0;
  const pctTxt = Math.round(pct * 10) / 10; // ex: 82.5
  const currentSimple = `${name} ${pctTxt}%`;

  // --- BEST SCORE POUR LE SOMMAIRE ---
  // Lire l'ancien meilleur s'il existe
  const prevSimple = localStorage.getItem('score_helice_v1') || '';
  // Extraire le pourcentage num√©rique de l'ancien (ex "Adrien 82.5%" -> 82.5)
  let prevPct = -1;
  const m = prevSimple.match(/([0-9]+(?:\.[0-9]+)?)%/);
  if (m) {
    prevPct = parseFloat(m[1]);
  }

  // Si pas d'ancien ou si le pourcentage actuel est meilleur -> on remplace
  if (pct > prevPct) {
    localStorage.setItem('score_helice_v1', currentSimple);
  }

  // rafra√Æchir affichage interne
  renderScoreTable();
  drawChart();
}

function buildSummary(){
  const total=filteredQuestions.length;
  let ok=0, bad=0, to=0;
  const lines = answersLog.map((r,idx)=>{
    const corr=r.choices[r.correctIndex];
    const user = r.pickedIndex===null ? '(aucune/temps)' : r.choices[r.pickedIndex];
    if(r.correct) ok++; else if(r.timedOut) to++; else bad++;
    const cls=r.correct?'ok':'bad';
    return `<div class="${cls}">Q${idx+1}. ${r.q}<div class="small">Ta r√©ponse: <b>${user}</b> ‚Äî Corr: <b>${corr}</b></div></div>`;
  }).join('');
  $('#summaryStats').innerHTML = `Score: <b>${score}</b> / ${total} &nbsp; | &nbsp; OK: <span class="ok">${ok}</span> ‚Äì Faux: <span class="bad">${bad}</span> ‚Äì Temps: <span class="bad">${to}</span>`;
  $('#summaryList').innerHTML = lines || '<span class="muted">Rien √† afficher</span>';
}
function finishGame(){
  if(!running) return;
  clearTick(); running=false; paused=false;
  $('#pauseBtn').disabled=true; $('#stopBtn').disabled=true;

  if(mode==='EXAM'){
    score = answersLog.reduce((acc,r)=> acc + (r.correct?1:0), 0);
    scoreEl.textContent=score;
  }
  buildSummary();
  $('#summaryCard').style.display='block';
  recordFinalScore();
  localStorage.removeItem(LS_SNAPSHOT);
}
$('#printSummary').onclick=()=>window.print();
$('#closeSummary').onclick=()=>$('#summaryCard').style.display='none';

// ====== Snapshot (reprendre une partie)
function saveSnapshot(){
  if(!running) return;
  const snap={ t:Date.now(), mode, perQ, i, score, filteredQuestions, questionOrder, answersLog };
  localStorage.setItem(LS_SNAPSHOT, JSON.stringify(snap));
}
function loadSnapshot(){ try{ return JSON.parse(localStorage.getItem(LS_SNAPSHOT)||'null') }catch{ return null } }
function applySnapshot(s){ mode=s.mode; perQ=s.perQ; i=s.i; score=s.score; filteredQuestions=s.filteredQuestions; questionOrder=s.questionOrder; answersLog=s.answersLog||[]; $('#mode').value=mode; $('#qSeconds').value=perQ; scoreEl.textContent=score; renderQuestion(); }
(function maybeShowResume(){
  const s=loadSnapshot(); if(!s) return;
  const btn=$('#resumeBtn'); btn.style.display='inline-block';
  btn.onclick=()=>{ btn.style.display='none'; running=true; paused=false; applySnapshot(s); $('#pauseBtn').disabled=false; $('#stopBtn').disabled=false; startTick(); };
})();

// ====== Wire + boot



(function boot(){ progressTxt.textContent='Question 0/0'; timerEl.textContent='0'; renderScoreTable(); drawChart(); })();
</script>
</body>
</html>


